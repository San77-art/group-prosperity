<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Editar Perfil - GP</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Inter', sans-serif;
    }
    .card {
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .avatar-option {
      cursor: pointer;
      border: 3px solid transparent;
      border-radius: 10px;
      transition: all 0.3s;
    }
    .avatar-option.selected {
      border-color: #401bc5;
      transform: scale(1.05);
    }
    footer {
      margin-top: 60px;
    }
  </style>
</head>
<body>

  <!-- 🔒 Proteção: Verifica login antes de carregar a página -->
  <!-- (único script necessário - evita duplicação) -->
  <script>
    fetch('/api/usuario', { method: 'GET', credentials: 'same-origin' })
      .then(r => {
        if (!r.ok) throw new Error('Não autenticado');
      })
      .catch(() => {
        window.location.href = '/?erro=1';
      });
  </script>

  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-person me-2"></i> Editar Perfil</h5>
          </div>
          <div class="card-body">
            <form id="formPerfil">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Nome</label>
                  <input type="text" class="form-control" id="nome" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Sobrenome</label>
                  <input type="text" class="form-control" id="sobre" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Celular</label>
                  <input type="text" class="form-control" id="celular" required>
                </div>
              </div>
              <button type="submit" class="btn btn-success">Salvar Perfil</button>
            </form>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-image me-2"></i> Escolher Avatar</h5>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-3">
                <img src="/man.jpeg" class="img-fluid avatar-option selected" data-value="man.jpeg" alt="Avatar 1">
              </div>
              <div class="col-3">
                <img src="/woman.jpeg" class="img-fluid avatar-option" data-value="woman.jpeg" alt="Avatar 2">
              </div>
              <div class="col-3">
                <img src="/man1.jpeg" class="img-fluid avatar-option" data-value="man1.jpeg" alt="Avatar 3">
              </div>
              <div class="col-3">
                <img src="/woman1.jpeg" class="img-fluid avatar-option" data-value="woman1.jpeg" alt="Avatar 4">
              </div>
            </div>
            <div class="text-center mt-3">
              <button id="salvarAvatar" class="btn btn-primary">Salvar Avatar</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header bg-danger text-white">
            <h5 class="mb-0"><i class="bi bi-lock me-2"></i> Alterar Senha</h5>
          </div>
          <div class="card-body">
            <form id="formSenha">
              <div class="mb-3">
                <label class="form-label">Senha Atual</label>
                <input type="password" class="form-control" id="senhaAtual" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Nova Senha</label>
                <input type="password" class="form-control" id="novaSenha" required>
                <div class="form-text text-muted">
                  Mínimo 6 caracteres, com número e letra maiúscula.
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Confirmar Nova Senha</label>
                <input type="password" class="form-control" id="confirmaSenha" required>
              </div>
              <button type="submit" class="btn btn-danger">Alterar Senha</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <footer class="mt-5 text-center">
      <div class="row">
        <div class="col-12 text-center">
          <p class="mb-0">&copy; 2025 Evoluir Show - 4 Níveis. Todos os direitos reservados.</p>
        </div>
      </div>
    </footer>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Script principal -->
  <script>
    // Dados do usuário
    let usuario = null;

    // Carregar dados do usuário
    fetch('/api/usuario')
      .then(r => r.json())
      .then(data => {
        usuario = data;

        // Preencher perfil
        document.getElementById('nome').value = data.nome?.split(' ')[0] || '';
        document.getElementById('sobre').value = data.nome?.split(' ').slice(1).join(' ') || '';
        document.getElementById('celular').value = data.celular || '';

        // Preencher avatar atual
        const avatarAtual = data.avatar.replace('/', '');
        document.querySelectorAll('.avatar-option').forEach(img => {
          if (img.dataset.value === avatarAtual) {
            img.classList.add('selected');
          } else {
            img.classList.remove('selected');
          }
        });
      })
      .catch(err => {
        console.error('Erro ao carregar usuário:', err);
        window.location.href = '/?erro=1';
      });

    // Salvar perfil
    document.getElementById('formPerfil').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = {
        nome: document.getElementById('nome').value,
        sobre: document.getElementById('sobre').value,
        celular: document.getElementById('celular').value
      };
      const res = await fetch('/api/perfil', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });
      if (res.ok) {
        alert('Perfil atualizado!');
        // Atualiza o nome no sidebar (se estiver no mesmo domínio)
        try {
          parent.document.getElementById('nomeUsuario').textContent = `${formData.nome} ${formData.sobre}`;
        } catch (e) {}
      } else {
        alert('Erro ao atualizar perfil.');
      }
    });

    // Salvar avatar
    document.getElementById('salvarAvatar').addEventListener('click', async () => {
      const selected = document.querySelector('.avatar-option.selected');
      if (!selected) return;
      const res = await fetch('/api/avatar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ avatar: selected.dataset.value })
      });
      if (res.ok) {
        const src = '/' + selected.dataset.value;
        document.getElementById('profileAvatar').src = src;
        document.getElementById('sidebarAvatar').src = src;
        alert('Avatar atualizado!');
      } else {
        alert('Erro ao atualizar avatar.');
      }
    });

    // Seleção de avatar
    document.querySelectorAll('.avatar-option').forEach(img => {
      img.addEventListener('click', () => {
        document.querySelectorAll('.avatar-option').forEach(i => i.classList.remove('selected'));
        img.classList.add('selected');
      });
    });

    // Alterar senha
    document.getElementById('formSenha').addEventListener('submit', async (e) => {
      e.preventDefault();
      const atual = document.getElementById('senhaAtual').value;
      const nova = document.getElementById('novaSenha').value;
      const confirma = document.getElementById('confirmaSenha').value;

      if (nova !== confirma) {
        return alert('Senhas não coincidem');
      }

      const res = await fetch('/api/senha', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ atual, nova })
      });
      const data = await res.json();
      alert(data.mensagem);
    });
  </script>
</body>
</html>