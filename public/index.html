<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GP - Painel Moderno</title>

  <!-- Google Fonts + Bootstrap + √çcones -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8f9fa;
      color: #333;
    }
    .sidebar {
      height: 100vh;
      background-color: #401bc5;
      color: white;
    }
    .sidebar a {
      color: white;
      text-decoration: none;
      display: block;
      padding: 12px 20px;
      transition: background-color 0.3s;
    }
    .sidebar a:hover {
      background-color: #dfddde;
      color: #401bc5;
    }
    .card-icon {
      font-size: 40px;
      margin-bottom: 10px;
    }
    .card-title {
      font-weight: 600;
      font-size: 1rem;
    }
    /* Estilo para sauda√ß√£o do usu√°rio */
    #usuarioLogado {
      padding: 15px 20px;
      font-weight: 600;
      font-size: 1.1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      text-align: center;
    }
    /* Alertas personalizados */
    .alert-success {
      background-color: #d1e7dd;
      color: #0f5132;
      border-radius: 8px;
      padding: 8px;
      font-size: 0.9rem;
    }
    .alert-warning {
      background-color: #fff3cd;
      color: #856404;
      border-radius: 8px;
      padding: 8px;
      font-size: 0.9rem;
    }
    .alert-info {
      background-color: #d1ecf1;
      color: #0c5460;
      border-radius: 8px;
      padding: 8px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">

      <!-- Sidebar -->
      <nav class="col-md-3 col-lg-2 d-md-block sidebar p-0">
        <div class="text-center py-4">
          <img src="https://via.placeholder.com/150x50?text=Evoluir+Show" class="img-fluid" alt="Logo Evoluir Show" />
        </div>

        <!-- Sauda√ß√£o din√¢mica -->
        <div id="usuarioLogado">
          Bem-vindo(a), <span id="nomeUsuario">Usu√°rio</span>!
        </div>

        <a href="#"><i class="bi bi-house-door"></i> In√≠cio</a>
        <a href="new-account.html"><i class="bi bi-person-plus"></i> Novo Cadastro</a>
        <a href="profile-ch.html"><i class="bi bi-person"></i> Editar Perfil</a>
        <a href="receipts.html"><i class="bi bi-currency-dollar"></i> Doa√ß√µes</a>
        <a href="#" onclick="confirmarSair(event)" class="text-decoration-none">
          <i class="bi bi-box-arrow-right text-danger"></i> Sair
        </a>
      </nav>

      <!-- Main Content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
        <h2 class="mb-4">Painel de Controle</h2>

        <div class="row g-3">

          <!-- Doa√ß√µes Recebidas -->
          <div class="col-md-3">
            <div class="card shadow-sm text-center p-3">
              <div class="card-icon text-success"><i class="bi bi-cash-stack"></i></div>
              <div class="card-title">Doa√ß√µes Recebidas</div>
              <h4 class="text-success">R$ 1.000,00</h4>
            </div>
          </div>

          <!-- Doa√ß√µes Feitas -->
          <div class="col-md-3">
            <div class="card shadow-sm text-center p-3">
              <div class="card-icon text-danger"><i class="bi bi-cash-coin"></i></div>
              <div class="card-title">Doa√ß√µes Feitas</div>
              <h4 class="text-danger">R$ 1.400,00</h4>
            </div>
          </div>

          <!-- Ciclo Atual -->
          <div class="col-md-3">
            <div class="card shadow-sm text-center p-3">
              <div class="card-icon text-info"><i class="bi bi-bar-chart"></i></div>
              <div class="card-title">Ciclo Atual</div>
              <h4 class="text-info">1¬∞</h4>
            </div>
          </div>

          <!-- Indicados Ativos -->
          <div class="col-md-3">
            <div class="card shadow-sm text-center p-3">
              <div class="card-icon text-warning"><i class="bi bi-people-fill"></i></div>
              <div class="card-title">Indicados Ativos</div>
              <h4 class="text-warning">0</h4>
            </div>
          </div>

          <!-- Seu Giro Atual -->
          <div class="col-md-3">
            <div class="card shadow-sm text-center p-3">
              <div class="card-icon text-primary"><i class="bi bi-arrow-repeat"></i></div>
              <div class="card-title">Seu Giro Atual</div>
              <h4 class="text-primary">N√≠vel <span id="nivelUsuario">1</span></h4>
              <p>Posi√ß√£o na fila: <span id="posicaoFila">N√£o inscrito</span></p>
            </div>
          </div>

          <!-- Pr√≥ximas Doa√ß√µes a Receber -->
          <div class="col-md-6">
            <div class="card shadow-sm text-center p-3">
              <div class="card-icon text-success"><i class="bi bi-gift"></i></div>
              <div class="card-title">Pr√≥ximas Doa√ß√µes a Receber</div>
              <div id="proximoPagamento">
                <p class="text-muted">Carregando...</p>
              </div>
            </div>
          </div>

        </div>
      </main>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // üîí Prote√ß√£o: se o fetch falhar, n√£o fique em loop
    async function carregarUsuario() {
      try {
        const res = await fetch('/api/usuario', { 
          method: 'GET', 
          credentials: 'same-origin' 
        });

        if (!res.ok) {
          throw new Error('N√£o autenticado');
        }

        const data = await res.json();
        document.getElementById('nomeUsuario').textContent = data.nome;
      } catch (err) {
        console.warn('Usu√°rio n√£o autenticado ou erro na API:', err);
        // Redireciona limpo, sem loop
        window.location.href = '/?erro=1';
      }
    }

    // Chama apenas uma vez
    if (document.getElementById('nomeUsuario')) {
      carregarUsuario();
    }
  </script>

  <script>
    // Carregar n√≠vel e posi√ß√£o na fila
    fetch('/api/giros')
      .then(r => r.json())
      .then(data => {
        document.getElementById('nivelUsuario').textContent = data.nivelAtual;
        if (data.posicaoNaFila) {
          document.getElementById('posicaoFila').textContent = `#${data.posicaoNaFila}`;
        } else {
          document.getElementById('posicaoFila').textContent = 'N√£o inscrito';
        }
      })
      .catch(err => console.error('Erro ao carregar giros:', err));

    // Carregar pr√≥xima doa√ß√£o
    fetch('/api/usuario')
      .then(r => r.json())
      .then(usuario => {
        if (!usuario.nivel || usuario.nivel === 1) {
          document.getElementById('proximoPagamento').innerHTML = `
            <p><i class="bi bi-info-circle text-warning"></i> N√≠vel 1: Reten√ß√£o inicial. Avance para o Giro 2.</p>
          `;
          return;
        }

        return fetch('/api/giros')
          .then(r => r.json())
          .then(girosData => {
            const nivelAtual = usuario.nivel;
            const giro = girosData.giros.find(g => g.nivel === nivelAtual);
            const posicao = girosData.posicaoNaFila;

            if (!giro) {
              document.getElementById('proximoPagamento').innerHTML = `
                <p class="text-danger"><i class="bi bi-exclamation-triangle"></i> Erro ao carregar dados do giro.</p>
              `;
              return;
            }

            const valorReceber = (giro.valor * 0.9).toFixed(2);

            if (posicao === null || posicao === undefined) {
              document.getElementById('proximoPagamento').innerHTML = `
                <p><i class="bi bi-clock text-warning"></i> Voc√™ n√£o est√° na fila do Giro ${nivelAtual}.</p>
                <button onclick="entrarNaFila()" class="btn btn-sm btn-outline-primary">Entrar na Fila</button>
              `;
            } else if (posicao === 1) {
              document.getElementById('proximoPagamento').innerHTML = `
                <div class="alert alert-success p-2">
                  <i class="bi bi-check-circle"></i> <strong>Pronto para receber!</strong><br>
                  Voc√™ receber√° <strong>US$ ${valorReceber}</strong> do pr√≥ximo doador.
                </div>
              `;
            } else {
              document.getElementById('proximoPagamento').innerHTML = `
                <p><i class="bi bi-user-clock text-info"></i> Voc√™ est√° na posi√ß√£o <strong>#${posicao}</strong></p>
                <p>Pr√≥ximo pagamento: <strong>US$ ${valorReceber}</strong></p>
                <p class="text-muted">Aguarde sua vez na fila</p>
              `;
            }
          });
      })
      .catch(err => {
        console.error('Erro ao carregar pr√≥xima doa√ß√£o:', err);
        document.getElementById('proximoPagamento').innerHTML = `
          <p class="text-danger"><i class="bi bi-exclamation-triangle"></i> Erro ao carregar dados.</p>
        `;
      });

    // Fun√ß√£o: entrar na fila
    function entrarNaFila() {
      fetch('/api/entrar-na-fila', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
          alert(data.mensagem || data.erro);
          location.reload();
        })
        .catch(err => {
          alert('Erro ao entrar na fila. Tente novamente.');
        });
    }

    // ‚úÖ Fun√ß√£o: confirmar sa√≠da
    function confirmarSair(event) {
      event.preventDefault();
      if (confirm('Tem certeza que deseja sair?')) {
        window.location.href = '/logout';
      }
    }
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>