<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - GP</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Inter', sans-serif;
    }
    .card {
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .status-badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .bg-pending {
      background-color: #ffc107;
      color: #000;
    }
    .bg-approved {
      background-color: #28a745;
      color: white;
    }
    .bg-rejected {
      background-color: #dc3545;
      color: white;
    }
    footer {
      margin-top: 60px;
    }
  </style>
</head>
<body>

  <!-- üîí Prote√ß√£o: Verifica login -->
  <script>
    fetch('/api/usuario', { method: 'GET', credentials: 'same-origin' })
      .then(r => {
        if (!r.ok) throw new Error('N√£o autenticado');
      })
      .catch(() => {
        window.location.href = '/?erro=1';
      });
  </script>

  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-lg-10">

        <h2 class="mb-4">Painel de Administra√ß√£o</h2>

        <!-- Fila de Giros -->
        <div class="card mb-4">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-people me-2"></i> Filas de Giros</h5>
          </div>
          <div class="card-body">
            <p class="text-muted">Usu√°rios aguardando para avan√ßar de n√≠vel.</p>
            <div id="filas">
              <div class="text-center">Carregando filas...</div>
            </div>
          </div>
        </div>

        <!-- Caixa do Sistema -->
        <div class="card mb-4">
          <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="bi bi-wallet2 me-2"></i> Caixa do Sistema</h5>
          </div>
          <div class="card-body">
            <p class="text-muted">Reten√ß√£o de 10% das doa√ß√µes para manuten√ß√£o.</p>
            <div id="caixa">
              <div class="text-center">Carregando caixa...</div>
            </div>
          </div>
        </div>

        <!-- Exportar Usu√°rios -->
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-download me-2"></i> Exportar Usu√°rios</h5>
          </div>
          <div class="card-body">
            <p class="text-muted">Baixe a lista completa de usu√°rios em CSV.</p>
            <button id="exportarUsuarios" class="btn btn-primary">Exportar para CSV</button>
          </div>
        </div>

      </div>
    </div>

    <footer class="mt-5 text-center">
      <div class="row">
        <div class="col-12 text-center">
          <p class="mb-0">&copy; 2025 Evoluir Show - 4 N√≠veis. Todos os direitos reservados.</p>
        </div>
      </div>
    </footer>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Script Principal -->
  <script>
    // Carregar filas
    fetch('/api/admin/filas')
      .then(r => r.json())
      .then(fila => {
        const div = document.getElementById('filas');
        div.innerHTML = '';

        for (let nivel = 2; nivel <= 5; nivel++) {
          const filaNivel = fila[nivel] || [];
          if (filaNivel.length === 0) continue;

          const ul = document.createElement('ul');
          ul.innerHTML = `<strong>Giro ${nivel}:</strong>`;
          filaNivel.forEach(u => {
            ul.innerHTML += `<li>${u.usuario} (Entrou em ${u.data})</li>`;
          });
          div.appendChild(ul);
        }

        if (div.children.length === 0) {
          div.innerHTML = '<p class="text-muted">Nenhuma fila com usu√°rios.</p>';
        }
      })
      .catch(err => {
        console.error('Erro ao carregar filas:', err);
        document.getElementById('filas').innerHTML = '<p class="text-danger">Erro ao carregar filas.</p>';
      });

    // Carregar caixa
    fetch('/api/admin/caixa')
      .then(r => r.json())
      .then(caixa => {
        const div = document.getElementById('caixa');
        div.innerHTML = `
          <p><strong>Total Retido:</strong> R$ ${caixa.totalRetido.toFixed(2)}</p>
          <p><strong>Movimenta√ß√µes:</strong> ${caixa.movimentacoes.length}</p>
          <ul>
            ${caixa.movimentacoes.map(m => `<li>${m.data}: R$ ${m.valor} (${m.descricao})</li>`).join('')}
          </ul>
        `;
      })
      .catch(err => {
        console.error('Erro ao carregar caixa:', err);
        document.getElementById('caixa').innerHTML = '<p class="text-danger">Erro ao carregar caixa.</p>';
      });

    // Exportar usu√°rios
    document.getElementById('exportarUsuarios').addEventListener('click', () => {
      window.location.href = '/api/admin/exportar';
    });
  </script>
</body>
</html>